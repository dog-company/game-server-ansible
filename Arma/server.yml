---
- hosts: game
  remote_user: arma
  vars:
    mods:
      - 450814997 # CBA_A3
      - 463939057 # ACE3
      - 583496184 # CUP Terrains - Core
      - 583544987 # CUP Terrains - Maps
      - 853743366 # CUP Terrains - CWA
      - 1375890861 # CUP ACE3 Compatibility Addon - Terrains
      - 843425103 # RHS AFRF
      - 843577117 # RHS USAF
      - 843593391 # RHS GREF
      - 843632231 # RHSSAF
      - 861133494 # JSRS Soundmod
      - 945476727 # JSRS SOUNDMOD - RHS AFRF Mod Pack Sound Support
      - 1180533757 # JSRS SOUNDMOD - RHS USAF Mod Pack Sound Support
      - 1180534892 # JSRS SOUNDMOD - RHS GREF Mod Pack Sound Support
      - 1486541773 # JSRS SOUNDMOD - RHS SAF Mod Pack Support
      - 773131200 # ACE Compat - RHS Armed Forces of the Russian Federation
      - 773125288 # ACE Compat - RHS United States Armed Forces
      - 884966711 # ACE Compat - RHS: GREF
      - 1185836585 # ACE3 RHS Missile Guidance Ð¡ompatibility
      - 1136518526 # Ace Particles 3.12.5.40
      - 708250744 # ACEX
      - 723217262 # Achilles
      - 620260972 # ALiVE
      - 820924072 # BackpackOnChest
      - 767380317 # Blastcore Edited (standalone version)
      - 667953829 # BloodLust
      - 1435263885 # Diwako's ACE Ragdolling
      - 366425329 # FIR AWS(AirWeaponSystem)
      - 1227179728 # EA-18G Growler
      - 537154025 # F-14 Tomcat
      - 582478120 # F-15 Eagle
      - 366423278 # F-16 Fighting Falcon
      - 743099837 # FA-18 Super Hornet
      - 708278910 # Island Panthera
      - 779520435 # Multi-play Uniforms
      - 735566597 # Project OPFOR
      - 1207709270 # Tao Folding Map
      - 620019431 # task_force_radio
      - 643530417 # USS Nimitz
      - 721359761 # Vcom AI V3.1
    admins:
      - "76561198007051865" # Giggaflop
      - "76561198041702905" # Simpleton216
      - "76561197961945422" # Oddis
      - "76561198065986954" # Gamer
      - "76561198042250946" # Akkedude

  tasks:
    - name: Install Arma requirements
      become: yes
      apt:
        name: "{{ packages }}"
        update_cache: yes
      vars:
        packages:
          - mailutils
          - postfix
          - curl
          - wget
          - file
          - bzip2
          - gzip
          - unzip
          - bsdmainutils
          - python
          - util-linux
          - ca-certificates
          - binutils
          - bc
          - jq
          - tmux
          - lib32gcc1
          - libstdc++6
          - libstdc++6:i386
          - git
          - rename
          - webhook

    - name: Download linuxgsm installer
      get_url:
        url: https://linuxgsm.sh
        dest: /home/arma/linuxgsm.sh
        mode: 0755

    - name: Install linuxgsm
      command: /home/arma/linuxgsm.sh arma3server
      args:
        chdir: /home/arma
        creates: /home/arma/arma3server

    - name: Install linuxgsm
      command: /home/arma/arma3server
      args:
        chdir: /home/arma
        creates: /home/arma/lgsm/config-lgsm/arma3server/

    - name: Set Arma Steam Username and Password
      template:
        src: steam.cfg
        dest: /home/arma/lgsm/config-lgsm/arma3server/common.cfg

    - name: Install Arma 3
      command: /home/arma/arma3server ai
      args:
        chdir: /home/arma
        creates: /home/arma/serverfiles
      register: result

    - name: Update Arma 3
      command: /home/arma/arma3server update
      when: result is skipped

    - name: Create Arma 3 Service
      become: yes
      copy:
        src: systemd.service
        dest: /etc/systemd/system/arma3.service

    - name: Set the ssh key
      copy:
        src: deploy_key.pem
        dest: /home/arma/.ssh/id_rsa
        mode: 0600

    - file:
        path: "{{ item }}"
        state: absent
      with_items:
        - "/home/arma/serverfiles/.git-mpmissions"
        - "/home/arma/serverfiles/mpmissions"

    - name: Get Missions
      git:
        repo: git@github.com:dog-company/missions.git
        dest: /home/arma/serverfiles/mpmissions
        accept_hostkey: yes
        separate_git_dir: /home/arma/serverfiles/.git-mpmissions

    - name: Remove mission folders
      command: find /home/arma/serverfiles/mpmissions/ -mindepth 1 -maxdepth 1 -type d -exec rm -rf {} \;

    - name: Template out modlist
      template:
        src: modlist.txt
        dest: /home/arma/modlist.txt
      register: result

    - name: Get Mods
      command: "/home/arma/steamcmd/steamcmd.sh +runscript /home/arma/modlist.txt"
      when: result is changed

    - name: Create mod dir
      file:
        path: /home/arma/serverfiles/mods
        state: directory

    - name: Sync modfiles into place
      command: rsync -ry --progress --delete /home/arma/Steam/workshop/steamapps/workshop/content/107410/ /home/arma/serverfiles/mods
      when: result is changed

    - name: Rename all files into lowercase
      command: find /home/arma/serverfiles/mods/ -depth -exec rename 's/(.*)\/([^\/]*)/$1\/\L$2/' {} \;
      when: result is changed

    - name: Redo bikey files for authorized mods
      command: find /home/arma/serverfiles/mods/ -type f -name "*.bikey" -exec cp {} /home/arma/serverfiles/keys \;
      when: result is changed

    - name: Configure the server
      template:
        src: server_settings.cfg
        dest: /home/arma/lgsm/config-lgsm/arma3server/arma3server.cfg

    - name: More configure the server
      template:
        src: arma3server.server.cfg
        dest: /home/arma/serverfiles/cfg/ara3server.server.cfg

    - name: Start server on reboot
      cron:
        name: "Start server on reboot"
        special_time: reboot
        job: "/home/arma/arma3server start"
        user: arma

    - name: Check server hourly
      cron:
        name: "Check server hourly"
        special_time: hourly
        job: "/home/arma/arma3server monitor"
        user: arma

    - name: Start server
      shell:  /home/arma/arma3server start
      args:
        executable: /bin/bash
        chdir: /home/arma

    - name: Create missions update script
      copy:
        src: update_missions.sh
        dest: /home/arma/update_missions.sh
        mode: 0755

    - name: Create webhooks directory
      become: yes
      file:
        path: /etc/webhook
        state: directory

    - name: Configure webhooks
      become: yes
      template:
        src: webhooks.json
        dest: /etc/webhook/hooks.json
        mode: 0666

    - name: Create webhook Service
      become: yes
      copy:
        src: webhooks.service
        dest: /etc/systemd/system/webhooks.service

    - name: Start and enable webhooks service
      systemd:
        state: restarted
        daemon_reload: yes
        name: webhooks